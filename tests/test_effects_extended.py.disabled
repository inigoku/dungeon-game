"""Tests extendidos para rendering/effects.py - Cobertura 75%+"""
import pytest
from unittest.mock import Mock, patch, MagicMock
from rendering.effects import EffectsRenderer
from models.cell import Cell, CellType, Direction


class TestEffectsRendererExtended:
    """Tests adicionales para alcanzar 75% de cobertura."""
    
    def test_draw_broken_line_horizontal(self):
        """Test línea quebrada horizontal."""
        mock_screen = Mock()
        renderer = EffectsRenderer(mock_screen, 90)
        
        color = (100, 100, 100)
        renderer.draw_broken_line(color, (0, 100), (200, 100), 2, 5, 5, "line1")
        
        assert mock_screen.method_calls
    
    def test_draw_broken_line_vertical(self):
        """Test línea quebrada vertical."""
        mock_screen = Mock()
        renderer = EffectsRenderer(mock_screen, 90)
        
        color = (100, 100, 100)
        renderer.draw_broken_line(color, (100, 0), (100, 200), 2, 5, 5, "line2")
        
        assert mock_screen.method_calls
    
    def test_draw_broken_line_diagonal(self):
        """Test línea quebrada diagonal."""
        mock_screen = Mock()
        renderer = EffectsRenderer(mock_screen, 90)
        
        color = (100, 100, 100)
        renderer.draw_broken_line(color, (0, 0), (200, 200), 3, 5, 5, "line3")
        
        assert mock_screen.method_calls
    
    def test_draw_broken_line_different_widths(self):
        """Test líneas con diferentes anchos."""
        mock_screen = Mock()
        renderer = EffectsRenderer(mock_screen, 90)
        
        color = (100, 100, 100)
        for width in [1, 2, 3, 5]:
            mock_screen.reset_mock()
            renderer.draw_broken_line(color, (0, 0), (100, 100), width, 5, 5, f"line{width}")
            assert mock_screen.method_calls
    
    def test_draw_broken_line_different_colors(self):
        """Test líneas con diferentes colores."""
        mock_screen = Mock()
        renderer = EffectsRenderer(mock_screen, 90)
        
        colors = [(0, 0, 0), (128, 128, 128), (255, 255, 255), (100, 50, 25)]
        for color in colors:
            mock_screen.reset_mock()
            renderer.draw_broken_line(color, (0, 0), (100, 100), 2, 5, 5, str(color))
            assert mock_screen.method_calls
    
    def test_draw_broken_line_same_start_end(self):
        """Test línea con mismo inicio y fin."""
        mock_screen = Mock()
        renderer = EffectsRenderer(mock_screen, 90)
        
        color = (100, 100, 100)
        renderer.draw_broken_line(color, (100, 100), (100, 100), 2, 5, 5, "same")
        
        # Debería manejar este caso
        assert True
    
    def test_draw_broken_line_different_seeds(self):
        """Test líneas con diferentes seeds."""
        mock_screen = Mock()
        renderer = EffectsRenderer(mock_screen, 90)
        
        color = (100, 100, 100)
        
        for row in range(3):
            for col in range(3):
                renderer.draw_broken_line(color, (0, 0), (100, 100), 2, row, col, "test")
        
        # Diferentes seeds deberían dar diferentes patrones
        assert True
    
    def test_draw_stone_texture_basic(self):
        """Test textura de piedra básica."""
        mock_screen = Mock()
        renderer = EffectsRenderer(mock_screen, 90)
        
        renderer.draw_stone_texture(5, 5, 100, 100)
        
        assert mock_screen.method_calls
    
    def test_draw_stone_texture_different_positions(self):
        """Test textura en diferentes posiciones."""
        mock_screen = Mock()
        renderer = EffectsRenderer(mock_screen, 90)
        
        positions = [(0, 0), (5, 5), (10, 10)]
        for row, col in positions:
            mock_screen.reset_mock()
            renderer.draw_stone_texture(row, col, 100, 100)
            assert mock_screen.method_calls
    
    def test_draw_stone_texture_different_coords(self):
        """Test textura en diferentes coordenadas de pantalla."""
        mock_screen = Mock()
        renderer = EffectsRenderer(mock_screen, 90)
        
        coords = [(0, 0), (100, 100), (200, 200), (500, 500)]
        for x, y in coords:
            mock_screen.reset_mock()
            renderer.draw_stone_texture(5, 5, x, y)
            assert mock_screen.method_calls
    
    def test_draw_stone_in_walls_no_exits(self):
        """Test piedra en paredes sin salidas."""
        mock_screen = Mock()
        renderer = EffectsRenderer(mock_screen, 90)
        
        cell = Cell(CellType.HABITACION, set())
        mock_callback = Mock(return_value=0)
        
        renderer.draw_stone_in_walls(5, 5, 100, 100, cell, 0.8, mock_callback)
        
        assert mock_screen.method_calls
    
    def test_draw_stone_in_walls_all_exits(self):
        """Test piedra en paredes con todas las salidas."""
        mock_screen = Mock()
        renderer = EffectsRenderer(mock_screen, 90)
        
        cell = Cell(CellType.PASILLO, {Direction.N, Direction.S, Direction.E, Direction.O})
        mock_callback = Mock(return_value=0)
        
        renderer.draw_stone_in_walls(5, 5, 100, 100, cell, 0.8, mock_callback)
        
        assert mock_screen.method_calls
    
    def test_draw_stone_in_walls_north_exit(self):
        """Test piedra con salida norte."""
        mock_screen = Mock()
        renderer = EffectsRenderer(mock_screen, 90)
        
        cell = Cell(CellType.PASILLO, {Direction.N})
        mock_callback = Mock(return_value=0)
        
        renderer.draw_stone_in_walls(5, 5, 100, 100, cell, 0.8, mock_callback)
        
        assert mock_screen.method_calls
    
    def test_draw_stone_in_walls_south_exit(self):
        """Test piedra con salida sur."""
        mock_screen = Mock()
        renderer = EffectsRenderer(mock_screen, 90)
        
        cell = Cell(CellType.PASILLO, {Direction.S})
        mock_callback = Mock(return_value=0)
        
        renderer.draw_stone_in_walls(5, 5, 100, 100, cell, 0.8, mock_callback)
        
        assert mock_screen.method_calls
    
    def test_draw_stone_in_walls_east_exit(self):
        """Test piedra con salida este."""
        mock_screen = Mock()
        renderer = EffectsRenderer(mock_screen, 90)
        
        cell = Cell(CellType.PASILLO, {Direction.E})
        mock_callback = Mock(return_value=0)
        
        renderer.draw_stone_in_walls(5, 5, 100, 100, cell, 0.8, mock_callback)
        
        assert mock_screen.method_calls
    
    def test_draw_stone_in_walls_west_exit(self):
        """Test piedra con salida oeste."""
        mock_screen = Mock()
        renderer = EffectsRenderer(mock_screen, 90)
        
        cell = Cell(CellType.PASILLO, {Direction.O})
        mock_callback = Mock(return_value=0)
        
        renderer.draw_stone_in_walls(5, 5, 100, 100, cell, 0.8, mock_callback)
        
        assert mock_screen.method_calls
    
    def test_draw_stone_in_walls_different_brightness(self):
        """Test piedra con diferentes brillos."""
        mock_screen = Mock()
        renderer = EffectsRenderer(mock_screen, 90)
        
        cell = Cell(CellType.PASILLO, {Direction.N})
        mock_callback = Mock(return_value=2)
        
        for brightness in [0.0, 0.3, 0.6, 1.0]:
            mock_screen.reset_mock()
            renderer.draw_stone_in_walls(5, 5, 100, 100, cell, brightness, mock_callback)
            assert mock_screen.method_calls
    
    def test_draw_stone_in_walls_different_torch_counts(self):
        """Test piedra con diferentes cantidades de antorchas."""
        mock_screen = Mock()
        renderer = EffectsRenderer(mock_screen, 90)
        
        cell = Cell(CellType.HABITACION, set())
        
        for torch_count in [0, 1, 2, 3, 5]:
            mock_screen.reset_mock()
            mock_callback = Mock(return_value=torch_count)
            renderer.draw_stone_in_walls(5, 5, 100, 100, cell, 0.8, mock_callback)
            assert mock_screen.method_calls
    
    def test_different_cell_sizes_effects(self):
        """Test efectos con diferentes tamaños de celda."""
        mock_screen = Mock()
        
        for cell_size in [50, 70, 90, 110]:
            renderer = EffectsRenderer(mock_screen, cell_size)
            
            # Probar cada tipo de efecto
            renderer.draw_broken_line((100, 100, 100), (0, 0), (100, 100), 2, 5, 5, "test")
            renderer.draw_stone_texture(5, 5, 100, 100)
            
            cell = Cell(CellType.PASILLO, {Direction.N})
            mock_callback = Mock(return_value=2)
            renderer.draw_stone_in_walls(5, 5, 100, 100, cell, 0.8, mock_callback)
    
    def test_all_effects_together(self):
        """Test todos los efectos juntos."""
        mock_screen = Mock()
        renderer = EffectsRenderer(mock_screen, 90)
        
        # Línea quebrada
        renderer.draw_broken_line((100, 100, 100), (0, 0), (100, 100), 2, 5, 5, "line")
        
        # Textura de piedra
        renderer.draw_stone_texture(5, 5, 100, 100)
        
        # Piedra en paredes
        cell = Cell(CellType.PASILLO, {Direction.N, Direction.S})
        mock_callback = Mock(return_value=2)
        renderer.draw_stone_in_walls(5, 5, 100, 100, cell, 0.8, mock_callback)
        
        assert mock_screen.method_calls
